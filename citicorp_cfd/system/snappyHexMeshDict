FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}

castellatedMesh true;
snap            true;
addLayers       true;

geometry
{
    citicorp_tower
    {
        type triSurface;
        file "citicorp_tower.stl";
    }

    citicorp_stilts
    {
        type triSurface;
        file "citicorp_stilts.stl";
    }

    surroundings
    {
        type triSurface;
        file "surroundings.stl";
    }

    // Urban region — covers surrounding building cluster (level 1)
    urbanRegion
    {
        type searchableBox;
        min  (-180 -340 0);
        max  (500 340 300);
    }

    // Building region — Citicorp + immediate neighbors (level 2)
    buildingRegion
    {
        type searchableBox;
        min  (-80 -80 0);
        max  (80 80 320);
    }

    // Wake refinement region downstream of Citicorp (level 1)
    wakeRegion
    {
        type searchableBox;
        min  (24 -100 0);
        max  (400 100 200);
    }

    // Stilt underpass region — fine resolution (level 3)
    stiltRegion
    {
        type searchableBox;
        min  (-30 -30 0);
        max  (30 30 40);
    }
}

castellatedMeshControls
{
    maxLocalCells       5000000;
    maxGlobalCells      10000000;
    minRefinementCells  10;
    maxLoadUnbalance    0.10;
    nCellsBetweenLevels 3;

    features
    (
        {
            file "citicorp_tower.eMesh";
            level 4;
        }
        {
            file "citicorp_stilts.eMesh";
            level 4;
        }
        {
            file "surroundings.eMesh";
            level 3;
        }
    );

    refinementSurfaces
    {
        citicorp_tower
        {
            level (3 4);
            patchInfo
            {
                type wall;
            }
        }

        citicorp_stilts
        {
            level (3 4);
            patchInfo
            {
                type wall;
            }
        }

        surroundings
        {
            level (2 3);
            patchInfo
            {
                type wall;
            }
        }
    }

    resolveFeatureAngle 30;

    refinementRegions
    {
        urbanRegion
        {
            mode inside;
            level 1;
        }

        buildingRegion
        {
            mode inside;
            level 2;
        }

        wakeRegion
        {
            mode inside;
            level 1;
        }

        stiltRegion
        {
            mode inside;
            level 3;
        }
    }

    // Point inside domain, OUTSIDE all buildings (z=500 > tallest bldg 278.9m)
    insidePoint (0 0 500);

    allowFreeStandingZoneFaces true;
}

snapControls
{
    nSmoothPatch    3;
    tolerance       2.0;
    nSolveIter      100;
    nRelaxIter      5;
    nFeatureSnapIter 10;
    implicitFeatureSnap false;
    explicitFeatureSnap true;
    multiRegionFeatureSnap false;
}

addLayersControls
{
    relativeSizes   true;

    layers
    {
        citicorp_tower
        {
            nSurfaceLayers 3;
        }
        citicorp_stilts
        {
            nSurfaceLayers 3;
        }
        surroundings
        {
            nSurfaceLayers 2;
        }
        ground
        {
            nSurfaceLayers 2;
        }
    }

    expansionRatio      1.2;
    finalLayerThickness 0.3;
    minThickness        0.1;
    nGrow               0;
    featureAngle        60;
    slipFeatureAngle    30;
    nRelaxIter          5;
    nSmoothSurfaceNormals 1;
    nSmoothNormals      3;
    nSmoothThickness    10;
    maxFaceThicknessRatio 0.5;
    maxThicknessToMedialRatio 0.3;
    minMedialAxisAngle  90;
    nBufferCellsNoExtrude 0;
    nLayerIter          50;
}

meshQualityControls
{
    maxNonOrtho     65;
    maxBoundarySkewness 20;
    maxInternalSkewness 4;
    maxConcave      80;
    minVol          1e-13;
    minTetQuality   -1e30;
    minArea         -1;
    minTwist        0.02;
    minDeterminant  0.001;
    minFaceWeight   0.05;
    minVolRatio     0.01;
    minTriangleTwist -1;
    nSmoothScale    4;
    errorReduction  0.75;
}

mergeTolerance 1e-6;
